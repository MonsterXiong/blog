# 什么是分布式锁？

比如有多个服务端，A、B、C 经过分布式锁对共有资源进行访问，只有 A 可以成功，B 和 C 失败，这种在分布式系统中控制多个进程对共有资源的访问成为分布式锁。

## 分布式锁具有的性质

互斥性：同一时刻，只有一个客户端可以获取锁。

安全性：锁的获取和释放是同一个客户端。

可用性：高可用的分布式锁系统及避免产生死锁

## 怎样用 Redis 实现分布式锁？

### setnx+expire 加锁

setnx 如果 key 不存在 set 成功返回 1，失败返回 0，保证互斥；

expire 设置过期时间，防止锁的长期持有或死锁。

但这种方式是不正确的，因为 setnx 和 expire 直接会发生异常导致死锁。

### set 原子方法加锁

```sh
SET key value NX EX expire-time

# 直接使用set方法进行加锁，避免死锁。NX和EX为固定值，前者表示SET IF NOT Exist，后者表示添加过期时间，具体时间取最后一个参数
```

该方法出现在 Redis2.6.12 以后，可以直接将 set 方法和设置过期时间统一成一个原子操作，避免产生死锁。

### 比较删除解锁

在通过比较删除进行解锁，删除 key 之前，判断是否为加锁的客户端，如果是则删除，如果不是则不删除，保证安全性。

```sh
DEL key
# 删除之前判断是否为加锁的客户端，可以通过添加客户端的唯一id（具体实现自己决定）到value中，每次删除前比较，一致再进行删除解锁，保证安全性
```
