# 域名系统 DNS

域名 DNS 系统（Domain Name System）是因特网使用的命名系统，用来把人们使用的机器名字转换为 IP 地址。

用户与因特网上某个主机通信时，必须要知道对方的 IP 地址。然而用户很难记住长达 32 位二进制主机地址（即使是点分十进制的 IP 地址也不太容易记忆）。所以应用层为了便于用户记忆各种网络应用，更多的使用的是主机名字，hosts 的文件中列出了所有主机名字和相应的 IP 地址。只要用户输入一个主机名字，计算机就可以很快地把这个主机名字转换成机器能够识别的二进制 IP 地址。

为什么机器在处理 IP 地址数据报时要使用 IP 地址而不使用域名呢？

这是因为 IP 地址的长度是固定的 32 位（如果是 IPV6 地址，那就是 128 位也是定长的），而域名的长度并不是固定的，机器处理起来比较困难。

因特网的域名系统 DNS 被设计成为一个联机分布式数据库系统，并采用客户-服务器方式。DNS 使大多数名字都在本地进行解析（resolve：在 TCP/IP 的文档中，这种地址转换常称为地址解析。解析就是转换的意思，地址解析可能会包含多次的查询请求和回答过程。），仅少量解析需要在因特网上通信，因此 DNS 系统的效率较高。由于 DNS 是分布式系统，即使单个计算机出了故障，也不会妨碍整个 DNS 系统的正常运行。

## DNS 缓存

为了提高 DNS 的查询效率，并减轻根域名服务器的负荷和减少因特网上的 DNS 查询报文数量，在域名服务器中广发地使用了高速缓存（也称高速缓存域名服务器），用来存放最近查询过地域名以及从何处获得域名映射信息的记录。

不但在本地域名服务器中需要高速缓存，在主机中也很需要。许多主机在启动时从本地域名服务器下载名字和地址的全部数据库，维护存放自己最近使用的域名的告诉缓存，并且只在从缓存中找不到名字时才使用域名服务器。维护本地域名服务器数据库的主机，应该定期地检查域名服务器以获取新地映射信息，而且主机必须从缓存中删掉无效的项。由于域名改动并不频繁，大多数网点不需花太多精力就能维护数据库地一致性 。

### windows 查看系统 DNS 缓存

`WIN+R`输入 cmd（命令提示符窗口），然后

- ipconfig/displaydns 查看系统内的 DNS 缓存
- ipconfig/flushdns 清空 DNS 缓存

### 浏览器查看 DNS 缓存

在 Chrome 浏览器中输入：`chrome://net-internals/#dns`

Clear host cache 清空缓存

## 解析顺序

1. 浏览器缓存

   - 当用户通过浏览器访问某域名时，浏览器首先会在自己的缓存中查找是否有该域名对应的 IP 地址（若曾经访问过该域名且没有情况缓存便存在）。

2. 系统缓存

   - 当浏览器缓存没有命中时则会自动检查用户计算机系统 Hosts 文件 DNS 缓存是否有该域名对应 IP

3. 路由器缓存

   - 当浏览器和系统缓存都没有命中时则进入路由器缓存中检查，以上三步均为客户端的 DNS 缓存。

4. ISP DNS 缓存

   - 在用户客户端查找不到域名对应的 IP 地址，则将进入 ISP DNS 缓存中进行查询。比如你用的是移动的网络，则会进入移动的 DNS 缓存服务器中查找。

5. 根域名服务器

   - 如果以上均未命中，则进入跟服务器进行查询。全球仅有 13 台根域名服务器，1 一个主根域名服务器，其余 12 台辅根域名服务器。根域名服务器收到请求后会查看区域文件记录，若无则将其管辖范围内顶级域名（如.com）服务器 IP 告诉本地 DNS 服务器；

6. 顶级域名服务器

   - 顶级域名服务器收到请求后查看区域文件记录，若无则将其管辖范围内主域名服务器的 IP 地址告诉本地 DNS 服务器；

7. 主域名服务器

   - 主域名服务器接收到请求后查询自己的缓存，如果没有则进入下一级域名服务器查找，并重复该步骤直至找到正确记录；

8. 保存结果至缓存

   - 本地域名服务器将返回的结果保存到缓存，以备下一次使用，同时将该结果反馈给客户端，客户端通过这个 IP 地址与 web 服务器建立连接。

## DNS 服务的体系架构

DNS 主要作用就是将主机域名转换为 IP 地址，假设运行在用户主机上的某些程序需要将主机名转换为 IP 地址。这些应用程序将调用 DNS 的客户端，并指明需要被转换的主机名。（在很多基于 UNIX 的机器上，应用程序为了执行这种转换需要调用 gethostbyname（））。用户主机的 DNS 客户端接收到后，向网络中发送一个 DNS 查询报文。所有 DNS 请求和回答报文使用 UDP 数据包经过端口 53 发送，经过若干 ms 到若干 s 的延时后，用户主机上的 DNS 客户端接收到一个提供所希望映射的 DNS 回答报文。这个查询结果则被传递到调用 DNS 的应用程序。因此，从客户主机上调用应用程序的角度看，DNS 是一个提供简单、直接的转换服务的黑盒子。但事实上，实现这个服务的黑盒子非常复杂，它由分布于全球的大量 DNS 服务器以及定义了 DNS 服务器与查询主机通信方式的应用层协议组成。

**DNS 采用的是分布式集群的工作方式而不是单点的集中式**

## 为什么使用 UDP 协议

DNS 是计算机域名系统的缩写，它是由域名解析器和域名服务器组成的。域名服务器是指保存有该网络中所有主机的域名和对应的 IP 地址，并且具有将域名转换为 IP 地址功能的服务器。其中一个域名必须对应一个 IP 地址，一个域名只能对应一个 IP 地址（比如访问一个域名不可能向两个 ip 地址请求），而 IP 地址不一定有域名且可以对应多个域名。域名系统采用类似目录树的等级结构。域名服务器为客户机/服务器模式中的服务器方，它主要有两种形式：主服务器和转发服务器。将域名映射为 IP 地址的过程就称为“域名解析”。

1. DNS 是应用层协议，客户端（一般指浏览器）构建 DNS 查询请求，依次被传输层、网络层、数据链路层等封装到达 DNS 服务器端，最终客户端接收到 DNS 响应消息。

2. DNS 主要基于 UDP 运输层协议，UDP 是无连接尽最大能力交付的不可靠数据连接，TCP 是面向连接的可靠数据连接

   - 一次 UDP 交换可以短到两个包：一个查询、一个响应。一次 TCP 交换则至少包含 9 个包：三次握手初始化 TCP 会话、一个查询包、一个响应包以及四次分手的包交换。
   - 考虑效率原因，TCP 连接的开销大，所以采用 UDP 作为 DNS 的运输层协议，只会在 UDP 报文中表明有截断的时候使用 TCP 查询
